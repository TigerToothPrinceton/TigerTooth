
<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous"> -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/rateit.css') }}" />

  <title>{{food[1]}} Description</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/reviews.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato" />
</head>

<body>

  <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-primary">
    <div class="container-fluid">
       <a class="navbar-brand fs-4" href="index"><img src="https://i.imgur.com/AufcPrM.png" width="auto" height="50"> TigerTooth</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <!-- <li class="nav-item">
            <a class="nav-link active fs-6" aria-current="page" href="/reactions?college={{college}}">View
              {{college.capitalize()}} Reactions</a>
          </li> -->
          <li class="nav-item">
            <a class="nav-link active fs-5 me-3" aria-current="page" href="/food?college={{college}}">View {{college.capitalize()}} Menu</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active fs-5 me-1" aria-current="page" href="/history">Your Reviews</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Food description portion -->
  {% if food|length == 0: %}
  {% else: %}
    <div class="container-fluid mt-5">
      <div class="row">
        <div class="col-1 col-sm-3 col-md-4"></div>
        <div class="col-10 col-sm-6 col-md-4 pl-1 pr-1">
          <figure>
            {% if food[0] is not none: %}
            <img src="{{food[0]}}" alt="" class="img-fluid rounded" style="height: auto; width: 100%;">
            {% endif %}
            <figcaption style="margin-top: 10px" id="rating-box">
              {{food[1]}}
              {% if food[2] == 0 %}
              <p style="margin: 10px 0;">Rating: No Rating Yet!</p>
              {% else: %}
              <p style="margin: 10px 0;">Rating: {{(food[3]/food[2])|round(1)}}</p>
              {% endif %}
            </figcaption>
          </figure>
        </div>
        <div class="col-1 col-sm-3 col-md-4"></div>
      </div>
    </div>
  {% endif %}
  
  <hr/>
  <!-- Review Display Portion -->
  <div class="container-fluid">
    <div class="row">
      <h3 class="text-xs-center text-center">Reviews</h3>
    </div>
  </div> 

  <div class="container-fluid">
    <div class="row" id="reviews-box">
    </div>
  </div>

  <br>
  <hr>
  <div class="container-fluid">
    <div class="row">
        <form action="food-desc" method="POST" class="reviews-form" id="form1">
          <div class="controls">
            <div class="row">
              <div class="col-2 col-md-3"></div>
              <div class="col-8 col-md-6">
                <p style="font-size: 18px; text-align:center;">Submit ratings and reviews here!</p>
                <div class="rateit mb-2" data-rateit-mode="font" data-rateit-resetable="false" style="font-size:40px" data-rateit-step="1" id="star_rating">
                </div>
                <div class="form-group">
                    <textarea name="review" class="form-control mb-4" id="reviews-text" placeholder="Leave a review here!" rows="3" cols = "30" ></textarea>
                </div>
              </div>
              <div class="col-2 col-md-3"></div>
            </div>
            <br>
            <div class ="row">
              <div class="col-sm"></div>
              <div class="col-sm">
                <p id="spnError" class="error" style="display: none; margin-top: -43px">Please select a rating!</p>
              </div>
              <div class="col-sm"></div>
            </div>
            <div class = "row">
              <div class="col-sm">
                <input type="submit" id="btnSubmit" class="btn btn-primary btn-send" value="Submit!">
                <input type="hidden" name="college" value="{{college}}">
                <input type="hidden" name="food_id" value="{{food_id}}">
              </div>
            </div>
          </div>
        </form>
    </div>
  </div>
  <br>
  <br>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.min.js"></script>
  
  <script type=text/javascript>
      'use strict';
  
      let request = null;

      $(document).ready(function() {
        if (request != null)
            request.abort();
        
        let reqData = {
          food_id: $("[name='food_id']").val(),
          college: $("[name='college']").val(),
        };

        request = $.ajax(
          {
            type: 'GET',
            url: "/food-updates",
            data: reqData,
            success: function(response) {
              $('#reviews-box').html(response['reviews']);
            },
            error: function(err) {
              console.log(err);
            },
          }
        );
        
        $("#form1").submit(function (event) 
        {
            let formData = {
              rate: $('#star_rating').rateit('value'),
              review: $("#reviews-text").val(),
              food_id: $("[name='food_id']").val(),
            };
            
            // Set the Valid Flag to True if one RadioButton from the Group of RadioButtons is checked.
            let star_value = $('#star_rating').rateit('value');
            let isValid = true;
            if (star_value == 0) {
              isValid = false;
            }

            // Display error message if no star is selected.
            if (isValid) {
              console.log("Submit button clicked")
              $.ajax({
                type: "POST",
                url: "/food-updates",
                data: formData,
              }).done(function (data) {
                console.log(data);
                $('#reviews-text').val('');
                $('#star_rating').rateit('reset');
                // $('#reviews-box').prepend(formData['review'])

                let reqData = {
                  food_id: $("[name='food_id']").val(),
                  college: $("[name='college']").val(),
                };

                $.ajax(
                  {
                    type: 'GET',
                    url: "/food-updates",
                    data: reqData,
                    success: function(response) {
                      $('#rating-box > p').html(response['food_rating'])
                      $('#reviews-box').html(response['reviews']);
                    },
                    error: function(err) {
                      console.log(err);
                    },
                  }
                );
              }).catch(function (err) {
                console.log(err);
              });
  
              event.preventDefault();
            }
            else {
              // $("#spnError")[0].style.display = isValid ? "none" : "block";
              event.preventDefault();
              $("#spnError")[0].style.display = "block";
              return false;
            }
        });

        // $("#btnSubmit").click(function () {
        //   // Set the Valid Flag to True if one RadioButton from the Group of RadioButtons is checked.
        //   let star_value = $('#star_rating').rateit('value');
        //   let isValid = true;
        //   if (star_value == 0) {
        //     isValid = false;
        //   }
        //   // var isValid = $("input[name=rate]").is(":checked");

        //   // Display error message if no star is selected.
        //   if (isValid) {
        //     console.log("Submit button clicked")
        //     // longPoll();
        //   }
        //   else {
        //     // $("#spnError")[0].style.display = isValid ? "none" : "block";
        //     $("#spnError")[0].style.display = "block";
        //   }
        // });

        $("#star_rating").click(function () {
          $("#spnError")[0].style.display = "none";
        });

        // $("#star2").click(function () {
        //   $("#spnError")[0].style.display = "none";
        // });

        // $("#star3").click(function () {
        //   $("#spnError")[0].style.display = "none";
        // });

        // $("#star4").click(function () {
        //   $("#spnError")[0].style.display = "none";
        // });

        // $("#star5").click(function () {
        //   $("#spnError")[0].style.display = "none";
        // });
      });
  </script>

  <script src="{{ url_for('static', filename='js/jquery.rateit.min.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
</body>

</html>
