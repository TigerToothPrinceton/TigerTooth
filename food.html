<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}" />
  

  <title>{{college.capitalize()}} {{meal_time}} Menu</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/food.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/reactions.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato" />

  <script>
    $(document).ready(function(){
        function alignModal(){
            var modalDialog = $(this).find(".modal-dialog");

            // Applying the top margin on modal to align it vertically center
            modalDialog.css("margin-top", Math.max(0, ($(window).height() - modalDialog.height()) / 2));
        }
        // Align modal when it is displayed
        $(".modal").on("shown.bs.modal", alignModal);

        // Align modal when user resize the window
        $(window).on("resize", function(){
            $(".modal:visible").each(alignModal);
        });   
    });
  </script>
  
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-primary">
    <div class="container-fluid">
       <a class="navbar-brand fs-4" href="index"><img src="https://i.imgur.com/AufcPrM.png" width="auto" height="50"> TigerTooth</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <!-- <li class="nav-item">
            <a class="nav-link active fs-6 me-2" aria-current="page" href="/reactions?college={{college}}">View
              {{college.capitalize()}} Reactions</a>
          </li> -->
          <li class="nav-item">
            <a class="nav-link active fs-5 me-3" aria-current="page" href="/history">Your Reviews</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="food-dhall-title" id="food_title">
    <h1>{{college.capitalize()}} {{meal_time}}</h1>
  </div>
  <div class="container mb-4">
    <div style="display: flex; align-items: center; justify-content: center">
      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#reactions" id="show_hide">
        View Reactions!
      </button>
    </div>
  </div>
  {% if foods|length == 0: %}
  {% else: %}

  <!-- For large devices like laptops -->
  <div class="card-group mx-5 text-center justify-content-center mb-4" id="card_group">
      {% for food in foods: %}
      <div class="card mx-auto mx-sm-3 my-3 rounded" style="min-width: 16rem; max-width: 16rem;">
        {% if food[0] is none: %}
        <a href="/foodimg-submit?api_id={{food[5]}}&college={{college}}"><img src="" alt="Submit a Photo Here!"
            class="img-fluid rounded card-img-top" style="min-height: 11rem; max-height: 11rem;"></a>
        {% else: %}
        <a href="/food-desc?food_id={{food[4]}}&college={{college}}"><img src="{{food[0]}}" alt="No photo"
            class="img-fluid rounded card-img-top" style="min-height: 11rem; max-height: 11rem;"></a>
        {% endif %}
      <div class="card-body">
        <h5 class="card-title">
          <a href="/food-desc?food_id={{food[4]}}&college={{college}}" style="color: inherit;">{{food[1]}}</a>
        </h5>
        {% if food[2] == 0 %}
        <p class="card-text">Rating: No Rating Yet!</p>
        {% else: %}
        <p class="card-text">Rating: {{(food[3]/food[2])|round(1)}}</p>
        {% endif %}
        <a href="/food-desc?food_id={{food[4]}}&college={{college}}" class="btn bttn rounded" style="color: #fff">Submit a Review</a>
      </div>
    </div>
    {% endfor %}
  </div>

  {% endif %}

  <div class = "container-fluid">
    <!-- <div style="display: flex; align-items: center; justify-content: center">
      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#reactions" id="show_hide">
        View Reactions!
      </button>
    </div> -->
    <div class="modal fade" id="reactions" tabindex="-1" role="dialog" aria-labelledby="reactionsTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header" style = "text-align:center; vertical-align:middle">
            <h5 class="modal-title" id="reactionsTitle">Reactions</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
          {% if rows|length == 0: %}
          {% else: %}
          <div class="container-fluid">
            <div class="row">
                  <div class="col-1"></div>
                  <div class="col-10 pl-1 pr-1"
                    style="border:2px solid #000000; border-radius: 0.4rem; min-height: 40vh; max-height:40vh; overflow: auto" id="message-box">
                  </div>
                  <div class="col-1"></div>
            </div>
          </div>
          {% endif %}
          <br>
          <div class="container-fluid">
            <div class="row">
              <form action="reactions" method="POST" class="reactions-form" id="form1">
                <div class="controls">
                  <div class="row">
                    <div class="col-2"></div>
                    <div class="col-8">
                      <div class="form-group">
                        <textarea name="reaction" class="form-control" placeholder="Enter your reaction here!" rows="3"
                          cols="30" id="reactions-text" required></textarea>
                      </div>
                    </div>
                    <div class="col-2"></div>
                  </div>
                  <br>
                    <div class="row">
                      <div class="col-sm">
                        <input type="submit" class="btn btn-primary btn-send" value="React" id="submit_but">
                        <input type="hidden" id="collegeid" name="college" value="{{college}}">
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <br>
  <br>
 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.min.js"></script>
  <script type=text/javascript>
    'use strict';

    $(document).ready(function() {
      $('#form1').validate({
        errorClass: "error fail-alert",
        messages : {
          reaction: {
          required: "Please enter a reaction!",
          }
        }
      });

      $("#form1").submit(function (event) 
      {
          let formData = {
            reaction: $("#reactions-text").val(),
            college: $("#collegeid").val(),
          };
          
          if (formData.reaction != '') {
            $.ajax({
              type: "POST",
              url: "/reactions",
              data: formData,
            }).done(function (data) {
              console.log(data);
              $('#reactions-text').val('');
            }).catch(function (err) {
              console.log(err);
            });

            event.preventDefault();
          }
      });

      // window.setInterval(function() {
      //       let college = $('#collegeid').val();
      //       college = encodeURIComponent(college);
      //       let url = '/reactions?college=' + college
            
      //       $.ajax(
      //          {
      //             type: 'GET',
      //             url: url,
      //             success: function(response) {
      //               $('#message-box').html(response);
      //             },
      //             error: function(err) {
      //               console.log(err);
      //             }
      //          }
      //       );
      // }, 1000);

      $('#show_hide').click(function() {
        console.log("React button clicked")
        longPoll();
      })
    });

    function longPoll() {
      console.log("In the longPoll function")
      let college = $('#collegeid').val();
      college = encodeURIComponent(college);
      let url = '/reactions?college=' + college

      $.ajax(
        {
          type: 'GET',
          url: url,
          success: function(response) {
            $('#message-box').html(response);
          },
          error: function(err) {
            console.log(err);
          },
          complete: longPoll
        }
      );
    }

        //  function handleResponse(response)
        //  { 
        //     $('#message-box').html(response);
        //  }

        //  function handleError(err)
        //  {
        //    console.log(err)
        //  }
          
        //  let request = null;
         
        //  function getReactions()
        //  {    
        //     let college = $('#collegeid').val();
        //     college = encodeURIComponent(college);
        //     let url = '/reactions?college=' + college
            
        //     if (request != null)
        //        request.abort();
            
        //     request = $.ajax(
        //        {
        //           type: 'GET',
        //           url: url,
        //           success: handleResponse
        //           error: handleError
        //        }
        //     );
        //  }

        //  function postReactions()
        //  {
        //    $("#form1").submit
        //    (
        //      function (event) 
        //      {
        //         let formData = {
        //           reaction: $("#reactions-text").val(),
        //           college: $("#collegeid").val(),
        //         };

        //         $.ajax({
        //           type: "POST",
        //           url: "/reactions",
        //           data: formData,
        //           dataType: "json",
        //           encode: true,
        //         }).done(function (data) {
        //           console.log(data);
        //         });

        //         event.preventDefault();
        //      }
        //    );
        //  }

        // //  function postReactions()
        // //  {
        // //   let formData = {
        // //     reaction: $("#reactions-text").val(),
        // //     college: $("#collegeid").val(),
        // //   };

        // //   $.ajax({
        // //     type: "POST",
        // //     url: "/reactions",
        // //     data: formData,
        // //     dataType: "json",
        // //     encode: true,
        // //   }).done(function (data) {
        // //     console.log(data);
        // //   }).catch(function (err) {
        // //     console.log(err)
        // //   });

        // //   event.preventDefault();
        // //  }
         
        //  function setup()
        //  {
        //     $('#form1').validate({
        //       errorClass: "error fail-alert",
        //       messages : {
        //         reaction: {
        //         required: "Please enter a reaction!",
        //         }
        //       }
        //     });
        //     $("#form1").submit(
        //       function (event) 
        //       {
        //           let formData = {
        //             reaction: $("#reactions-text").val(),
        //             college: $("#collegeid").val(),
        //           };

        //           $.ajax({
        //             type: "POST",
        //             url: "/reactions",
        //             data: formData,
        //             dataType: "json",
        //             encode: true,
        //           }).done(function (data) {
        //             console.log(data);
        //           });

        //           event.preventDefault();
        //       });
        //     // $('#form1').on('submit', postReactions);
        //     window.setInterval(getReactions, 1000);
        //     // $('#authorInput').focus();
        //     // $('#authorInput').on('input', getResults);
        //  }
         
        //  $(document).ready(setup()); 
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
    crossorigin="anonymous"></script>
</body>

</html>
