<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}" />
  

  <title>{{college.capitalize()}} {{meal_time}} Menu</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/food.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/reactions.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/reviews.css') }}" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato" />

  <script>
    $(document).ready(function(){
        function alignModal(){
            var modalDialog = $(this).find(".modal-dialog");

            // Applying the top margin on modal to align it vertically center
            modalDialog.css("margin-top", Math.max(0, ($(window).height() - modalDialog.height()) / 2));
        }
        // Align modal when it is displayed
        $(".modal").on("shown.bs.modal", alignModal);

        // Align modal when user resize the window
        $(window).on("resize", function(){
            $(".modal:visible").each(alignModal);
        });   
    });
  </script>
  
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-primary">
    <div class="container-fluid">
       <a class="navbar-brand fs-4" href="dhall"><img src="https://i.imgur.com/AufcPrM.png" width="auto" height="50"> TigerTooth</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <!-- <li class="nav-item">
            <a class="nav-link active fs-6 me-2" aria-current="page" href="/reactions?college={{college}}">View
              {{college.capitalize()}} Reactions</a>
          </li> -->
          <li class="nav-item">
            <a class="nav-link active fs-5 me-3" aria-current="page" href="/history">Your Reviews</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="food-dhall-title" id="food_title">
    <h1>{{college.capitalize()}} {{meal_time}}</h1>
  </div>
  <div class="container mb-4">
    <div style="display: flex; align-items: center; justify-content: center">
      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#reactions" id="show_hide">
        View Reactions!
      </button>
    </div>
  </div>
  {% if foods|length == 0: %}
  {% else: %}
  <!-- For large devices like laptops -->
  <div class="card-group mx-5 text-center justify-content-center mb-4" id="card_group">
    {% for food in foods: %}
    <div class="card mx-auto mx-sm-3 my-3 rounded" style="min-width: 16rem; max-width: 16rem;">
      {% if food[0] is none: %}
        <a href="/foodimg-submit?api_id={{food[5]}}&college={{college}}"><img src="" alt="Submit a Photo Here!"
            class="img-fluid rounded card-img-top" style="min-height: 11rem; max-height: 11rem;"></a>
      {% else: %}
        <div style="cursor: pointer">  
          <img src="{{food[0]}}" alt="No photo" class="img-fluid rounded card-img-top" 
               style="min-height: 11rem; max-height: 11rem;" onclick = "show({{loop.index}})">
        </div>
      {% endif %}
      <div class="card-body">
        <h5 class="card-title">
          <div style="color: inherit; cursor: pointer" onclick = "show({{loop.index}})">{{food[1]}}</div>
        </h5>
        {% if food[2] == 0 %}
          <p class="card-text">Rating: No Rating Yet!</p>
        {% else: %}
          <p class="card-text">Rating: {{(food[3]/food[2])|round(1)}}</p>
        {% endif %}
          <div class="btn bttn rounded" style="color: #fff" onclick = "show({{loop.index}})" 
               id = "button{{loop.index}}">Submit a Review</div>
      </div>
    </div>  
    {% endfor %}
  </div>
  {% endif %}
  {% if foods|length == 0: %}
  {% else: %}
    {% for food in foods: %}
      <div id = "rev{{loop.index}}" style = "display: none;">
        {% if food|length == 0: %}
        {% else: %}
          <div class="container-fluid mt-5" id="food_descrip">
            <div class="row">
              <div class="col-1 col-sm-3 col-md-4"></div>
              <div class="col-10 col-sm-6 col-md-4 pl-1 pr-1">
                <figure>
                  {% if food[0] is not none: %}
                  <img src="{{food[0]}}" alt="" class="img-fluid rounded" style="height: auto; width: 80%; 
                                                                                 margin-right:auto; margin-left:auto">
                  {% endif %}
                  <figcaption style="margin-top: 10px" id="rating-box">
                    {{food[1]}}
                    {% if food[2] == 0 %}
                    <p style="margin: 10px 0;">Rating: No Rating Yet!</p>
                    {% else: %}
                    <p style="margin: 10px 0;">Rating: {{(food[3]/food[2])|round(1)}}</p>
                    {% endif %}
                  </figcaption>
                </figure>
              </div>
              <div class="col-1 col-sm-3 col-md-4"></div>
            </div>
          </div>
        {% endif %}
        <div class="container-fluid reviews_area">
          <div class="row">
            <h3 class="text-xs-center text-center">Reviews</h3>
          </div>
        </div> 

        <div class="container-fluid reviews_area">
          <div class="row" id="reviews-box">
          </div>
        </div>

        <br>
        <div class="container-fluid" id="submit_area">
          <div class="row">
              <form action="food" method="POST" class="reviews-form" id="form1">
                <div class="controls">
                  <div class="row">
                    <div class="col-2 col-md-3"></div>
                    <div class="col-8 col-md-6">
                      <p style="font-size: 18px; text-align:center;">Submit ratings and reviews here!</p>
                      <div class="rateit mb-2" data-rateit-mode="font" data-rateit-resetable="false" style="font-size:40px" data-rateit-step="1" id="star_rating">
                      </div>
                      <div class="form-group">
                          <textarea name="review" class="form-control mb-4" id="reviews-text" placeholder="Leave a review here!" rows="3" cols = "30" ></textarea>
                      </div>
                    </div>
                    <div class="col-2 col-md-3"></div>
                  </div>
                  <br>
                  <div class ="row">
                    <div class="col-sm"></div>
                    <div class="col-sm">
                      <p id="spnError" class="error" style="display: none; margin-top: -43px">Please select a rating!</p>
                    </div>
                    <div class="col-sm"></div>
                  </div>
                  <div class = "row">
                    <div class="col-sm">
                      <input type="submit" id="btnSubmit" class="btn btn-primary btn-send" value="Submit!">
                      <input type="hidden" name="college" value="{{college}}">
                      <input type="hidden" name="food_id" value="{{food[4]}}">
                    </div>
                  </div>
                </div>
              </form>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}

  <div class = "container-fluid">

    <div class="modal fade" data-backdrop="false" id="reactions" tabindex="-1" role="dialog" aria-labelledby="reactionsTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" style = "max-width:80%" role="document">
        <div class="modal-content">
          <div class="modal-header" style = "text-align:center; vertical-align:middle">
            <h5 class="modal-title" id="reactionsTitle">Reactions</h5>
            <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true"></span>
            </button>
          </div>
          <div class="modal-body">
          {% if rows|length == 0: %}
          {% else: %}
          <div class="container-fluid">
            <div class="row">
                  <div class="col-1 col-sm-2"></div>
                  <div class="col-10 col-sm-8 pl-1 pr-1"
                    style="border:2px solid #000000; border-radius: 0.4rem; min-height: 50vh; max-height:50vh; overflow: auto" id="message-box">
                  </div>
                  <div class="col-1 col-sm-2"></div>
            </div>
          </div>
          {% endif %}
          <br>
          <div class="container-fluid">
            <div class="row">
              <form action="reactions" method="POST" class="reactions-form" id="formR">
                <div class="controls">
                  <div class="row">
                    <div class="col-2"></div>
                    <div class="col-8">
                      <div class="form-group">
                        <textarea name="reaction" class="form-control" placeholder="Enter your reaction here!" rows="3"
                          cols="30" id="reactions-text" required></textarea>
                      </div>
                    </div>
                    <div class="col-2"></div>
                  </div>
                  <br>
                    <div class="row">
                      <div class="col-sm">
                        <input type="submit" class="btn btn-primary btn-send" value="React" id="submit_but">
                        <input type="hidden" id="collegeid" name="college" value="{{college}}">
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <br>
  <br>
 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.0/jquery.validate.min.js"></script>

  <script>
    function show(index){
      temp = document.getElementById("rev" + index);
      if (temp.style.display === "none") {
        temp.style.display = "block";
        temp.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        temp.style.display = "none";
      }
    }
  </script>
  
   <script type=text/javascript>
      'use strict';
  
      let request = null;

      $(document).ready(function() {
        if (request != null)
            request.abort();
        
        let reqData = {
          food_id: $("[name='food_id']").val(),
          college: $("[name='college']").val(),
        };

        request = $.ajax(
          {
            type: 'GET',
            url: "/food-updates",
            data: reqData,
            success: function(response) {
              $('#reviews-box').html(response['reviews']);
            },
            error: function(err) {
              console.log(err);
            },
          }
        );
        
        $("#form1").submit(function (event) 
        {
            let formData = {
              rate: $('#star_rating').rateit('value'),
              review: $("#reviews-text").val(),
              food_id: $("[name='food_id']").val(),
            };

            let star_value = $('#star_rating').rateit('value');
            let isValid = true;
            if (star_value == 0) {
              isValid = false;
            }

            if (isValid) {
              console.log("Submit button clicked")
              $.ajax({
                type: "POST",
                url: "/food-updates",
                data: formData,
              }).done(function (data) {
                console.log(data);
                $('#reviews-text').val('');
                $('#star_rating').rateit('reset');


                let reqData = {
                  food_id: $("[name='food_id']").val(),
                  college: $("[name='college']").val(),
                };

                $.ajax(
                  {
                    type: 'GET',
                    url: "/food-updates",
                    data: reqData,
                    success: function(response) {
                      $('#rating-box > p').html(response['food_rating'])
                      $('#reviews-box').html(response['reviews']);
                    },
                    error: function(err) {
                      console.log(err);
                    },
                  }
                );
              }).catch(function (err) {
                console.log(err);
              });
  
              event.preventDefault();
            }
            else {

              event.preventDefault();
              $("#spnError")[0].style.display = "block";
              return false;
            }
        });

        $("#star_rating").click(function () {
          $("#spnError")[0].style.display = "none";
        });

      });
  </script>
  
  <script type=text/javascript>
    'use strict';

    $(document).ready(function() {
      $('#formR').validate({
        errorClass: "error fail-alert",
        messages : {
          reaction: {
          required: "Please enter a reaction!",
          }
        }
      });

      $("#formR").submit(function (event) 
      {
          let formData = {
            reaction: $("#reactions-text").val(),
            college: $("#collegeid").val(),
          };
          
          if (formData.reaction != '') {
            $.ajax({
              type: "POST",
              url: "/reactions",
              data: formData,
            }).done(function (data) {
              console.log(data);
              $('#reactions-text').val('');
            }).catch(function (err) {
              console.log(err);
            });

            event.preventDefault();
          }
      });
      $('#show_hide').click(function() {
        console.log("React button clicked")
        longPoll();
      })
    });

    function longPoll() {
      console.log("In the longPoll function")
      let college = $('#collegeid').val();
      college = encodeURIComponent(college);
      let url = '/reactions?college=' + college

      $.ajax(
        {
          type: 'GET',
          url: url,
          success: function(response) {
            $('#message-box').html(response);
          },
          error: function(err) {
            console.log(err);
          },
          complete: longPoll
        }
      );
    }

  </script>

    
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
    crossorigin="anonymous"></script>
</body>

</html>
